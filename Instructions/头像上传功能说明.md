# å¤´åƒä¸Šä¼ åŠŸèƒ½è¯´æ˜

## åŠŸèƒ½æ¦‚è¿°

ä¸ªäººèµ„æ–™é¡µé¢çš„å¤´åƒä¸Šä¼ åŠŸèƒ½å…è®¸ç”¨æˆ·é€‰æ‹©ã€é¢„è§ˆå¹¶ä¿å­˜ä¸ªäººå¤´åƒã€‚ç”¨æˆ·ä¸Šä¼ çš„å¤´åƒä¼šè¢«æŒä¹…åŒ–ä¿å­˜åˆ° `userData.json` æ–‡ä»¶ä¸­ï¼Œç¡®ä¿ç”¨æˆ·åˆ·æ–°é¡µé¢æˆ–é‡æ–°ç™»å½•æ—¶å¤´åƒèƒ½å¤Ÿæ­£ç¡®æ˜¾ç¤ºã€‚

## åŠŸèƒ½ç‰¹æ€§

### âœ¨ æ ¸å¿ƒåŠŸèƒ½
- ğŸ“· **å¤´åƒé€‰æ‹©**ï¼šç‚¹å‡»å¤´åƒåŒºåŸŸé€‰æ‹©æœ¬åœ°å›¾ç‰‡æ–‡ä»¶
- ğŸ‘€ **å®æ—¶é¢„è§ˆ**ï¼šé€‰æ‹©å›¾ç‰‡åç«‹å³æ˜¾ç¤ºé¢„è§ˆæ•ˆæœ
- ğŸ’¾ **æŒä¹…åŒ–å­˜å‚¨**ï¼šå¤´åƒURLä¿å­˜åˆ°userData.jsonæ–‡ä»¶
- ğŸ”„ **å³æ—¶æ›´æ–°**ï¼šä¸Šä¼ æˆåŠŸåç•Œé¢ç«‹å³æ›´æ–°æ˜¾ç¤ºæ–°å¤´åƒ
- âŒ **å–æ¶ˆåŠŸèƒ½**ï¼šæ”¯æŒå–æ¶ˆå½“å‰é€‰æ‹©çš„å¤´åƒ

### ğŸ›¡ï¸ å®‰å…¨ç‰¹æ€§
- **æ–‡ä»¶ç±»å‹éªŒè¯**ï¼šä»…æ”¯æŒå›¾ç‰‡æ–‡ä»¶æ ¼å¼
- **æ–‡ä»¶å¤§å°é™åˆ¶**ï¼šæœ€å¤§æ”¯æŒ2MBçš„å›¾ç‰‡æ–‡ä»¶
- **é”™è¯¯å¤„ç†**ï¼šå®Œå–„çš„é”™è¯¯æç¤ºå’Œå¤„ç†æœºåˆ¶

## æŠ€æœ¯å®ç°

### å‰ç«¯å®ç°

#### 1. ç»„ä»¶ç»“æ„ (`src/views/Profile/index.vue`)

```vue
<div class="avatar-upload">
  <div class="avatar-display" @click="triggerFileInput">
    <!-- å¤´åƒæ˜¾ç¤ºåŒºåŸŸ -->
    <div class="avatar-overlay">
      <span class="upload-text">ç‚¹å‡»ä¸Šä¼ </span>
    </div>
  </div>
  <input ref="fileInputRef" type="file" accept="image/*" @change="handleFileSelect" />
</div>

<!-- å¤´åƒé¢„è§ˆåŒºåŸŸ -->
<div v-if="previewAvatar" class="avatar-preview-section">
  <div class="preview-avatar" :style="{ backgroundImage: `url(${previewAvatar})` }"></div>
  <div class="preview-actions">
    <button @click="confirmAvatar">ç¡®è®¤ä½¿ç”¨</button>
    <button @click="cancelPreview">å–æ¶ˆ</button>
  </div>
</div>
```

#### 2. æ ¸å¿ƒå‡½æ•°

##### æ–‡ä»¶é€‰æ‹©å¤„ç†
```javascript
function handleFileSelect(event) {
  const file = event.target.files?.[0];
  
  // æ–‡ä»¶ç±»å‹éªŒè¯
  if (!file.type.startsWith('image/')) {
    showMessage('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶', 'error');
    return;
  }
  
  // æ–‡ä»¶å¤§å°éªŒè¯ (2MBé™åˆ¶)
  if (file.size > 2 * 1024 * 1024) {
    showMessage('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 2MB', 'error');
    return;
  }
  
  // åˆ›å»ºé¢„è§ˆURL
  const reader = new FileReader();
  reader.onload = (e) => {
    previewAvatar.value = e.target?.result;
  };
  reader.readAsDataURL(file);
}
```

##### å¤´åƒç¡®è®¤ä¸Šä¼ 
```javascript
async function confirmAvatar() {
  if (!avatarFile.value) return;
  
  avatarUploading.value = true;
  try {
    // åˆ›å»ºæœ¬åœ°URL
    const localUrl = URL.createObjectURL(avatarFile.value);
    
    // è°ƒç”¨åç«¯APIä¿å­˜å¤´åƒURLåˆ°userData.json
    const result = await uploadUserAvatar(authStore.userInfo!.id, localUrl);
    
    if (result.success) {
      showMessage('å¤´åƒä¸Šä¼ æˆåŠŸï¼');
      // æ›´æ–°ç•Œé¢æ˜¾ç¤º
      avatarUrl.value = result.data?.avatarUrl || localUrl;
      // é‡æ–°åŠ è½½ç”¨æˆ·èµ„æ–™
      await loadUserProfile();
    }
  } finally {
    avatarUploading.value = false;
  }
}
```

#### 3. APIè°ƒç”¨ (`src/api/profile.ts`)

```typescript
export async function uploadUserAvatar(userId: number, avatarUrl: string): Promise<{
    success: boolean;
    message: string;
    data?: {
        avatarUrl: string;
        userId: number;
    };
}> {
    try {
        const response = await axiosInstance.put(`/profile/${userId}/avatar`, {
            avatarUrl
        });
        return response.data;
    } catch (error: any) {
        return {
            success: false,
            message: error.response?.data?.message || 'å¤´åƒä¸Šä¼ å¤±è´¥'
        };
    }
}
```

### åç«¯å®ç° (`mockServer.js`)

#### 1. å¤´åƒä¸Šä¼ APIæ¥å£

```javascript
app.put('/api/profile/:userId/avatar', (req, res) => {
    try {
        const userId = parseInt(req.params.userId);
        const { avatarUrl } = req.body;
        
        // è¾“å…¥éªŒè¯
        if (!avatarUrl) {
            return res.status(400).json({
                success: false,
                message: 'å¤´åƒURLä¸èƒ½ä¸ºç©º'
            });
        }
        
        // æŸ¥æ‰¾ç”¨æˆ·
        let targetUser = null;
        for (const user of Object.values(users)) {
            if (user.id === userId) {
                targetUser = user;
                break;
            }
        }
        
        if (!targetUser) {
            return res.status(404).json({
                success: false,
                message: 'ç”¨æˆ·ä¸å­˜åœ¨'
            });
        }
        
        // ç¡®ä¿profileå¯¹è±¡å­˜åœ¨
        if (!targetUser.profile) {
            targetUser.profile = {
                fullName: '',
                phone: '',
                bio: '',
                avatar: '',
                avatarUrl: '',
                twoFactorEnabled: false,
                lastPasswordChange: new Date().toISOString().split('T')[0]
            };
        }
        
        // æ›´æ–°å¤´åƒ
        targetUser.profile.avatar = avatarUrl;
        targetUser.profile.avatarUrl = avatarUrl;
        
        // ä¿å­˜åˆ°userData.jsonæ–‡ä»¶
        const saveSuccess = saveUsers();
        
        res.json({
            success: true,
            message: 'å¤´åƒä¸Šä¼ æˆåŠŸ',
            data: {
                avatarUrl: avatarUrl,
                userId: userId
            }
        });
        
    } catch (error) {
        res.status(500).json({
            success: false,
            message: 'å¤´åƒä¸Šä¼ å¤±è´¥',
            error: error.message
        });
    }
});
```

#### 2. æ•°æ®ç»“æ„

##### userData.json æ–‡ä»¶ç»“æ„
```json
{
  "users": {
    "admin": {
      "id": 1,
      "username": "admin",
      "email": "admin@example.com",
      "profile": {
        "fullName": "æ›¾å¥³å£«",
        "phone": "13692774696",
        "bio": "",
        "avatar": "",
        "avatarUrl": "blob:http://localhost:3000/xxx-xxx-xxx",
        "twoFactorEnabled": false,
        "lastPasswordChange": "2025-09-04"
      }
    }
  }
}
```

## ä½¿ç”¨æµç¨‹

### ç”¨æˆ·æ“ä½œæ­¥éª¤

1. **è¿›å…¥ä¸ªäººèµ„æ–™é¡µé¢**
   - å¯¼èˆªåˆ° `/profile` è·¯å¾„
   - é¡µé¢æ˜¾ç¤ºå½“å‰ç”¨æˆ·ä¿¡æ¯å’Œå¤´åƒåŒºåŸŸ

2. **é€‰æ‹©å¤´åƒæ–‡ä»¶**
   - ç‚¹å‡»å¤´åƒæ˜¾ç¤ºåŒºåŸŸ
   - ç³»ç»Ÿæ‰“å¼€æ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†
   - é€‰æ‹©æœ¬åœ°å›¾ç‰‡æ–‡ä»¶ï¼ˆæ”¯æŒå¸¸è§å›¾ç‰‡æ ¼å¼ï¼‰

3. **é¢„è§ˆå¤´åƒ**
   - é€‰æ‹©æ–‡ä»¶åï¼Œç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆé¢„è§ˆ
   - é¢„è§ˆåŒºåŸŸæ˜¾ç¤ºé€‰æ‹©çš„å›¾ç‰‡
   - æ˜¾ç¤º"ç¡®è®¤ä½¿ç”¨"å’Œ"å–æ¶ˆ"æŒ‰é’®

4. **ç¡®è®¤ä¸Šä¼ **
   - ç‚¹å‡»"ç¡®è®¤ä½¿ç”¨"æŒ‰é’®
   - ç³»ç»Ÿæ˜¾ç¤ºä¸Šä¼ è¿›åº¦
   - ä¸Šä¼ æˆåŠŸåæ˜¾ç¤ºæˆåŠŸæç¤º

5. **å¤´åƒæ›´æ–°**
   - ç•Œé¢ç«‹å³æ˜¾ç¤ºæ–°å¤´åƒ
   - å¤´åƒæ•°æ®ä¿å­˜åˆ°æœåŠ¡å™¨
   - åˆ·æ–°é¡µé¢å¤´åƒä¾ç„¶æ˜¾ç¤º

### ç³»ç»Ÿå¤„ç†æµç¨‹

```mermaid
graph TB
    A[ç”¨æˆ·ç‚¹å‡»å¤´åƒåŒºåŸŸ] --> B[é€‰æ‹©å›¾ç‰‡æ–‡ä»¶]
    B --> C[æ–‡ä»¶éªŒè¯]
    C --> D{éªŒè¯é€šè¿‡?}
    D -->|å¦| E[æ˜¾ç¤ºé”™è¯¯æç¤º]
    D -->|æ˜¯| F[ç”Ÿæˆé¢„è§ˆ]
    F --> G[ç”¨æˆ·ç¡®è®¤ä¸Šä¼ ]
    G --> H[åˆ›å»ºæœ¬åœ°URL]
    H --> I[è°ƒç”¨åç«¯API]
    I --> J[ä¿å­˜åˆ°userData.json]
    J --> K[è¿”å›æˆåŠŸå“åº”]
    K --> L[æ›´æ–°ç•Œé¢æ˜¾ç¤º]
    L --> M[é‡æ–°åŠ è½½ç”¨æˆ·èµ„æ–™]
    E --> B
```

## æ–‡ä»¶è¯´æ˜

### ç›¸å…³æ–‡ä»¶åˆ—è¡¨

| æ–‡ä»¶è·¯å¾„ | åŠŸèƒ½è¯´æ˜ |
|---------|---------|
| `src/views/Profile/index.vue` | ä¸ªäººèµ„æ–™é¡µé¢ä¸»ç»„ä»¶ï¼ŒåŒ…å«å¤´åƒä¸Šä¼ UI |
| `src/api/profile.ts` | ä¸ªäººèµ„æ–™ç›¸å…³APIæ¥å£å®šä¹‰ |
| `mockServer.js` | åç«¯æœåŠ¡å™¨ï¼Œå¤„ç†å¤´åƒä¸Šä¼ è¯·æ±‚ |
| `userData.json` | ç”¨æˆ·æ•°æ®å­˜å‚¨æ–‡ä»¶ |

### ä¸»è¦å‡½æ•°è¯´æ˜

#### å‰ç«¯å‡½æ•°

| å‡½æ•°å | åŠŸèƒ½ | ä½ç½® |
|-------|------|------|
| `handleFileSelect` | å¤„ç†æ–‡ä»¶é€‰æ‹©ï¼ŒéªŒè¯æ–‡ä»¶ç±»å‹å’Œå¤§å° | Profile/index.vue |
| `confirmAvatar` | ç¡®è®¤ä¸Šä¼ å¤´åƒï¼Œè°ƒç”¨APIä¿å­˜ | Profile/index.vue |
| `cancelPreview` | å–æ¶ˆå½“å‰é¢„è§ˆçš„å¤´åƒ | Profile/index.vue |
| `loadUserProfile` | åŠ è½½ç”¨æˆ·èµ„æ–™ï¼ŒåŒ…æ‹¬å¤´åƒä¿¡æ¯ | Profile/index.vue |
| `uploadUserAvatar` | è°ƒç”¨åç«¯å¤´åƒä¸Šä¼ API | api/profile.ts |

#### åç«¯æ¥å£

| æ¥å£ | æ–¹æ³• | åŠŸèƒ½ |
|------|------|------|
| `/api/profile/:userId/avatar` | PUT | ä¿å­˜ç”¨æˆ·å¤´åƒURLåˆ°æ•°æ®æ–‡ä»¶ |
| `/api/profile/:userId` | GET | è·å–ç”¨æˆ·èµ„æ–™ï¼ŒåŒ…æ‹¬å¤´åƒä¿¡æ¯ |

## é…ç½®è¯´æ˜

### æ–‡ä»¶å¤§å°é™åˆ¶
- **å‰ç«¯é™åˆ¶**ï¼š2MB (åœ¨ `handleFileSelect` å‡½æ•°ä¸­è®¾ç½®)
- **ä¿®æ”¹æ–¹æ³•**ï¼šæ›´æ”¹ `2 * 1024 * 1024` è¿™ä¸ªå€¼

### æ”¯æŒçš„æ–‡ä»¶æ ¼å¼
- **å½“å‰æ”¯æŒ**ï¼šæ‰€æœ‰å›¾ç‰‡æ ¼å¼ (`image/*`)
- **ä¿®æ”¹æ–¹æ³•**ï¼šæ›´æ”¹ `accept="image/*"` å±æ€§

### å­˜å‚¨æ–¹å¼
- **å½“å‰æ–¹æ¡ˆ**ï¼šä½¿ç”¨ `URL.createObjectURL()` ç”Ÿæˆæœ¬åœ°blob URL
- **æ•°æ®æŒä¹…åŒ–**ï¼šä¿å­˜åˆ° `userData.json` æ–‡ä»¶
- **æ³¨æ„äº‹é¡¹**ï¼šblob URLåœ¨æµè§ˆå™¨åˆ·æ–°åå¯èƒ½å¤±æ•ˆï¼Œé€‚åˆæœ¬åœ°æ¼”ç¤º

## é”™è¯¯å¤„ç†

### å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ

1. **æ–‡ä»¶ç±»å‹é”™è¯¯**
   - é”™è¯¯ä¿¡æ¯ï¼šè¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶
   - è§£å†³æ–¹æ¡ˆï¼šé€‰æ‹©æ­£ç¡®çš„å›¾ç‰‡æ ¼å¼æ–‡ä»¶

2. **æ–‡ä»¶è¿‡å¤§é”™è¯¯**
   - é”™è¯¯ä¿¡æ¯ï¼šå›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 2MB
   - è§£å†³æ–¹æ¡ˆï¼šå‹ç¼©å›¾ç‰‡æˆ–é€‰æ‹©æ›´å°çš„æ–‡ä»¶

3. **ç½‘ç»œé”™è¯¯**
   - é”™è¯¯ä¿¡æ¯ï¼šç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•
   - è§£å†³æ–¹æ¡ˆï¼šæ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒæœåŠ¡å™¨çŠ¶æ€

4. **ç”¨æˆ·ä¸å­˜åœ¨**
   - é”™è¯¯ä¿¡æ¯ï¼šç”¨æˆ·ä¸å­˜åœ¨
   - è§£å†³æ–¹æ¡ˆï¼šç¡®è®¤ç”¨æˆ·å·²æ­£ç¡®ç™»å½•

## æ‰©å±•å»ºè®®

### åŠŸèƒ½å¢å¼º
1. **å›¾ç‰‡å‹ç¼©**ï¼šå‰ç«¯è‡ªåŠ¨å‹ç¼©å¤§å›¾ç‰‡
2. **å¤šæ ¼å¼æ”¯æŒ**ï¼šæ”¯æŒWebPç­‰ç°ä»£å›¾ç‰‡æ ¼å¼
3. **å¤´åƒè£å‰ª**ï¼šæä¾›å›¾ç‰‡è£å‰ªåŠŸèƒ½
4. **äº‘å­˜å‚¨**ï¼šé›†æˆäº‘å­˜å‚¨æœåŠ¡æ›¿ä»£æœ¬åœ°å­˜å‚¨

### æ€§èƒ½ä¼˜åŒ–
1. **ç¼“å­˜æœºåˆ¶**ï¼šæ·»åŠ å¤´åƒç¼“å­˜ç­–ç•¥
2. **æ‡’åŠ è½½**ï¼šå¤§é‡ç”¨æˆ·æ—¶ä½¿ç”¨æ‡’åŠ è½½
3. **CDNæ”¯æŒ**ï¼šä½¿ç”¨CDNåŠ é€Ÿå›¾ç‰‡åŠ è½½

### å®‰å…¨å¢å¼º
1. **æ–‡ä»¶æ‰«æ**ï¼šæ·»åŠ æ¶æ„æ–‡ä»¶æ£€æµ‹
2. **è®¿é—®æ§åˆ¶**ï¼šé™åˆ¶å¤´åƒè®¿é—®æƒé™
3. **æ°´å°åŠŸèƒ½**ï¼šè‡ªåŠ¨æ·»åŠ æ°´å°é˜²æ­¢ç›—ç”¨

## ç»´æŠ¤è¯´æ˜

### æ—¥å¿—è®°å½•
- åç«¯ä¼šè®°å½•æ‰€æœ‰å¤´åƒä¸Šä¼ æ“ä½œçš„è¯¦ç»†æ—¥å¿—
- åŒ…æ‹¬ç”¨æˆ·IDã€ä¸Šä¼ æ—¶é—´ã€æ–‡ä»¶ä¿¡æ¯ç­‰

### æ•°æ®å¤‡ä»½
- å»ºè®®å®šæœŸå¤‡ä»½ `userData.json` æ–‡ä»¶
- å…³é”®æ“ä½œå‰è¿›è¡Œæ•°æ®å¤‡ä»½

### ç›‘æ§å»ºè®®
- ç›‘æ§å¤´åƒä¸Šä¼ æˆåŠŸç‡
- è·Ÿè¸ªæ–‡ä»¶å¤§å°åˆ†å¸ƒ
- è®°å½•é”™è¯¯ç±»å‹å’Œé¢‘ç‡

---

> ğŸ“ **æ³¨æ„**: æ­¤åŠŸèƒ½ä½¿ç”¨æœ¬åœ°blob URLå­˜å‚¨å¤´åƒï¼Œé€‚åˆå¼€å‘å’Œæ¼”ç¤ºç¯å¢ƒã€‚ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨ä¸“ä¸šçš„æ–‡ä»¶å­˜å‚¨æœåŠ¡ã€‚