# 个人资料功能说明

## 功能概述

个人资料功能已经完全集成到现有的用户管理系统中，实现了与 userData.json 文件的数据共享和同步。

## 已实现的功能

### 1. 数据结构扩展

已为 userData.json 中的每个用户添加了 `profile` 字段，包含：

```json
{
  "profile": {
    "fullName": "用户姓名",
    "phone": "电话号码", 
    "bio": "个人简介",
    "avatar": "头像URL",
    "twoFactorEnabled": false,
    "lastPasswordChange": "2024-01-15"
  }
}
```

### 2. 后端API接口

新增了三个API接口：

#### 获取用户个人资料
- **路径**: `GET /api/profile/:userId`
- **功能**: 获取指定用户的完整个人资料信息
- **返回**: 包含基本信息和profile字段的完整用户数据

#### 更新用户个人资料  
- **路径**: `PUT /api/profile/:userId`
- **功能**: 更新用户的个人资料信息
- **支持字段**: email, fullName, phone, bio, twoFactorEnabled
- **自动保存**: 更新后自动同步到 userData.json 文件

#### 修改用户密码
- **路径**: `PUT /api/profile/:userId/password`
- **功能**: 验证当前密码并设置新密码
- **安全验证**: 验证当前密码正确性
- **自动更新**: 更新 lastPasswordChange 时间戳

### 3. 前端API服务

在 `src/services/api.ts` 中新增了三个函数：

- `fetchUserProfile(userId)` - 获取用户资料
- `updateUserProfile(userId, profileData)` - 更新用户资料  
- `changeUserPassword(userId, passwordData)` - 修改密码

### 4. 个人资料页面改造

`src/views/Profile/index.vue` 已完全重构：

- **真实数据加载**: 从后端API获取用户真实数据
- **实时保存**: 点击"保存更改"直接同步到 userData.json
- **密码修改**: 完整的密码修改流程，包含验证和错误处理
- **加载状态**: 添加加载动画和状态提示
- **错误处理**: 完善的错误提示和异常处理

## 数据流程

### 个人资料更新流程：
1. 用户在个人资料页面修改信息
2. 点击"保存更改"按钮
3. 前端调用 `updateUserProfile` API
4. 后端验证数据有效性
5. 更新内存中的用户数据
6. 自动保存到 userData.json 文件
7. 返回更新成功响应

### 密码修改流程：
1. 用户点击"修改密码"按钮
2. 输入当前密码和新密码
3. 前端调用 `changeUserPassword` API
4. 后端验证当前密码正确性
5. 更新密码和修改时间
6. 自动保存到 userData.json 文件
7. 返回修改成功响应

## 与用户管理的数据同步

- **共享数据源**: 个人资料和用户管理都使用同一个 userData.json 文件
- **实时同步**: 任何一方的修改都会立即反映到文件中
- **字段兼容**: 新添加的profile字段不影响现有用户管理功能
- **向后兼容**: 对于没有profile字段的老用户，系统会自动创建默认值

## 测试方式

### 1. 启动服务
```bash
# 启动mock服务器
npm run mock

# 启动前端开发服务器  
npm run dev
```

### 2. 测试步骤

1. **登录系统** - 使用现有账户登录
2. **访问个人资料** - 导航到个人资料页面
3. **查看数据加载** - 确认真实数据正确加载
4. **修改资料** - 更改姓名、电话、简介等信息并保存
5. **检查文件** - 查看 userData.json 文件确认数据已保存
6. **修改密码** - 测试密码修改功能
7. **用户管理验证** - 在用户管理页面确认邮箱等基本信息同步

### 3. 验证点

- ✅ 个人资料页面显示真实用户数据
- ✅ 修改后的信息能正确保存到 userData.json  
- ✅ 密码修改功能正常工作
- ✅ 用户管理页面的邮箱信息与个人资料同步
- ✅ 新用户自动创建默认profile字段
- ✅ 双重认证开关状态正确保存

## 技术实现细节

### 数据一致性保证
- 所有API操作都使用文件锁机制
- 每次更新后立即同步到磁盘
- 内存和文件数据保持一致

### 错误处理
- 网络请求异常处理
- 数据验证失败处理
- 文件保存失败容错

### 性能优化
- 只加载必要的用户数据
- 批量更新减少IO操作
- 前端状态管理优化

## 注意事项

1. **权限验证**: 目前用户只能修改自己的资料，后续可扩展管理员权限
2. **数据备份**: 建议定期备份 userData.json 文件
3. **扩展性**: profile字段可轻松扩展更多用户属性
4. **安全性**: 密码修改需要验证当前密码，确保安全

## 后续扩展建议

1. **头像上传**: 实现头像图片上传和存储
2. **数据验证**: 增强前端和后端数据验证规则
3. **操作日志**: 记录用户资料修改的操作日志
4. **权限控制**: 细化不同角色的资料修改权限